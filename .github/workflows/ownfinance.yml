name: Ownfinance CI Pipeline

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev, staging]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.pull_request.number || 'none' }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # -------------------------------
  # 1Ô∏è‚É£ QUALITY CHECKS
  # -------------------------------
  quality-checks:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: package-lock.json

      - run: npm ci
      - run: npm run lint
      - run: npm run type-check

      - name: Run unit tests
        run: npm run test:ci
        env:
          CI: true

      - name: Generate test coverage
        run: npm run test:coverage

      - name: Run E2E tests
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')) ||
          (github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'dev'))
        run: npm run test:e2e

  # -------------------------------
  # 2Ô∏è‚É£ SECURITY
  # -------------------------------
  security:
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - run: npm ci

      - name: NPM Audit
        run: npm audit --audit-level=moderate || echo "‚ö†Ô∏è Audit found issues but skipping unfixable major versions."

  # -------------------------------
  # 3Ô∏è‚É£ DEPENDENCY AUDIT
  # -------------------------------
  dependency-audit:
    runs-on: ubuntu-latest
    needs: security

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - run: npm ci

      - name: Audit CI (allowlist exceptions)
        run: |
          npx audit-ci --moderate \
            --allowlist \
            @uniswap/universal-router-sdk \
            @uniswap/permit2-sdk \
            @metamask/eth-json-rpc-provider \
            @metamask/sdk-communication-layer \
            @openzeppelin/contracts \
            elliptic \
            diff \
            cookie \
            tmp \
            undici

  # -------------------------------
  # 4Ô∏è‚É£ SECRET SCAN
  # -------------------------------
  secret-scan:
    runs-on: ubuntu-latest
    needs: dependency-audit

    steps:
      - uses: actions/checkout@v4

      - name: Install Gitleaks
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.4_linux_x64.tar.gz
          chmod +x gitleaks

      - name: Run Gitleaks
        run: ./gitleaks detect --config .gitleaks.toml --verbose --no-git

  # -------------------------------
  # 5Ô∏è‚É£ LICENSE CHECK
  # -------------------------------
  license-check:
    runs-on: ubuntu-latest
    needs: secret-scan

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - run: npm ci

      - name: Check licenses (allowlist exceptions)
        run: |
          npx license-checker \
            --onlyAllow "MIT;Apache-2.0;BSD-3-Clause;BSD-2-Clause;ISC;0BSD;Apache-1.1;Artistic-2.0;CC0-1.0;LGPL-2.1;LGPL-3.0;MPL-2.0;Unlicense" \
            --excludePackages "own-frontend@0.1.0;@uniswap/universal-router-sdk;@uniswap/permit2-sdk;@metamask/eth-json-rpc-provider;@metamask/eth-json-rpc-provider@1.0.1;@metamask/sdk-communication-layer;@metamask/sdk-communication-layer@0.33.1" \
            --summary

  # -----------------------
  # 6Ô∏è‚É£ DEPLOY TO VERCEL
  # -----------------------
  deploy:
    runs-on: ubuntu-latest
    needs: license-check
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [ "$BRANCH" = "main" ]; then
            vercel --prod --token "$VERCEL_TOKEN"
          elif [ "$BRANCH" = "staging" ]; then
            vercel --token "$VERCEL_TOKEN" --env NODE_ENV=staging
          elif [ "$BRANCH" = "dev" ]; then
            vercel --token "$VERCEL_TOKEN" --env NODE_ENV=development
          else
            echo "Skipping deploy for $BRANCH"
          fi

  # -------------------------------
  # 7Ô∏è‚É£ TELEGRAM ALERT ON FAILURE
  # -------------------------------
  notify:
    if: failure()
    needs:
      [
        quality-checks,
        security,
        dependency-audit,
        secret-scan,
        license-check,
        deploy,
      ]
    runs-on: ubuntu-latest

    steps:
      - name: Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
        run: |
          MESSAGE="üö® *Ownfinance CI/CD Failed!*%0ARepo: *$REPO*%0ABranch: *$BRANCH*%0ACommit: \`$COMMIT\`%0ABy: *$ACTOR*"

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "parse_mode=Markdown" \
            -d "text=$MESSAGE"