#!/bin/sh
# ---------------------------------------
# Ownfinance â€” Pre-Commit Security & Quality Gate
# ---------------------------------------

echo ""
echo "ğŸ§¬ Ownfinance Pre-Commit Checks Starting..."
echo "------------------------------------------"

# -----------------------
# 1ï¸âƒ£ Lint
# -----------------------
echo "ğŸ“ Running ESLint..."
npm run lint || {
  echo "âŒ Lint failed â€” fix issues before committing."
  exit 1
}

# -----------------------
# 2ï¸âƒ£ Type Safety
# -----------------------
echo "ğŸ§  Running TypeScript checks..."
npm run type-check || {
  echo "âŒ Type check failed â€” fix type errors before committing."
  exit 1
}

# -----------------------
# 3ï¸âƒ£ Unit Tests (fast only)
# -----------------------
echo "ğŸ§ª Running unit tests..."
npm run test:ci || {
  echo "âŒ Tests failed â€” commit blocked."
  exit 1
}

# -----------------------
# 4ï¸âƒ£ Local Security Audit (non-blocking)
# -----------------------
echo "ğŸ”’ Running npm security audit..."
npm audit --audit-level=high || echo "âš ï¸  Security warnings found â€” full audit runs in CI"

# -----------------------
# 5ï¸âƒ£ Secret Detection
# -----------------------
echo "ğŸ”‘ Scanning for secrets..."
if command -v gitleaks >/dev/null 2>&1; then
  gitleaks detect --source . --config .gitleaks.toml --no-git --verbose || {
    echo "âš ï¸  Potential secrets detected â€” review carefully."
  }
else
  echo "ğŸ’¡ Gitleaks not found. Install for better protection:"
  echo "   https://github.com/gitleaks/gitleaks"
fi

# -----------------------
# 6ï¸âƒ£ License Compliance (non-blocking)
# -----------------------
# Check for high-risk dependencies
echo "ğŸ“¦ Checking dependency licenses..."
npm run security:licenses || echo "âš ï¸  License compliance issues - review in CI"

echo ""
echo "âœ… Ownfinance pre-commit checks complete"
echo "------------------------------------------"
